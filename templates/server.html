<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <div class="sidebar">
        <h2>PyServe</h2>
        <a href="/">Home</a>
        <a class="active" href="/server">Dashboard</a>
    </div>

    <div class="main">
        <h1>File Dashboard</h1>

        <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
            <label class="upload-btn">
                Browse…
                <input type="file" name="file" onchange="document.getElementById('upload-form').submit()">
            </label>
            <input type="hidden" name="device_id" id="device_id">
        </form>

        <div id="cards"></div>
    </div>

    <!-- Download Modal -->
    <div class="modal-bg" id="modal-bg">
        <div class="modal">
            <h3>Download Warning</h3>
            <p class="modal-text">
                Files downloaded from this server may contain viruses or malware.
                Only download files if you trust the source.
            </p>

            <div class="modal-buttons">
                <button class="yes" id="modal-yes">Download</button>
                <button class="no" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let pendingDownload = null;
        let currentFiles = [];

        /* DEVICE ID: platform-random.hidden */
        (function ensureDeviceId() {
        let id = localStorage.getItem("pyserve_device_id");
        if (!id) {
        const platform = navigator.platform.replace(/\s+/g, "_");
        const key = Math.random().toString(36).substring(2, 8).toLowerCase();
        id = `${platform}-${key}.hidden`;
        localStorage.setItem("pyserve_device_id", id);
        }
        document.getElementById("device_id").value = id;
        })();

        /* DOWNLOAD MODAL */
        function openModal(url) {
        pendingDownload = url;
        document.getElementById("modal-bg").style.display = "flex";
        }

        function closeModal() {
        pendingDownload = null;
        document.getElementById("modal-bg").style.display = "none";
        }

        document.getElementById("modal-yes").onclick = () => {
        if (pendingDownload) window.location = pendingDownload;
        closeModal();
        };

        /* DELETE (no password — uploader only) */
        function deleteFile(filename) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/delete/" + filename;

        const id = document.createElement("input");
        id.type = "hidden";
        id.name = "device_id";
        id.value = localStorage.getItem("pyserve_device_id");

        form.appendChild(id);
        document.body.appendChild(form);
        form.submit();
        }

        /* RENDER CARDS */
        function renderCards(files) {
        const container = document.getElementById("cards");
        const myId = localStorage.getItem("pyserve_device_id");

        const same =
        currentFiles.length === files.length &&
        currentFiles.every((f, i) =>
        f.name === files[i].name &&
        f.size === files[i].size &&
        (f.meta.uploader || "") === (files[i].meta.uploader || "") &&
        (f.meta.ip || "") === (files[i].meta.ip || "")
        );

        if (same) return;

        currentFiles = files;
        container.innerHTML = "";

        files.forEach(file => {
        const uploader = file.meta.uploader || "Unknown";
        const ip = file.meta.ip || "Unknown";
        const size = (file.size / 1024).toFixed(1) + " KB";

        const uploaderHTML =
        uploader === myId
        ? `<span style="color:#3498db; font-weight:bold;">${uploader}</span>`
        : uploader;

        const deleteBtn =
        uploader === myId
        ? `<button class="delete-btn" onclick="deleteFile('${file.name}')">Delete</button>`
        : "";

        container.innerHTML += `
        <div class="card">
        <h2>${file.name}</h2>
        <p>Size: ${size}</p>
        <p>Uploaded by: ${uploaderHTML}</p>
        <p>IP Address: ${ip}</p>

        <button class="download-btn" onclick="openModal('/download/${file.name}')">Download</button>
        ${deleteBtn}
        </div>
        `;
        });
        }

        /* LIVE REFRESH */
        async function refresh() {
        const res = await fetch("/filelist");
        const data = await res.json();
        renderCards(data);
        }

        setInterval(refresh, 3000);
        refresh();
    </script>

</body>
</html>
